<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lyaris Control Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #1a1a2e;
      padding: 16px 24px;
      border-bottom: 2px solid #16213e;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    header h1 {
      font-size: 22px;
      color: #00d4aa;
      font-weight: 700;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-idle { background: #333; color: #888; }
    .status-mining { background: #0d3320; color: #00d4aa; }
    .status-paused { background: #3d2e0d; color: #f5a623; }
    .status-finished { background: #0d2133; color: #4a9eff; }
    .status-error { background: #330d0d; color: #ff4a4a; }
    .status-traveling { background: #1a1040; color: #a78bfa; }

    .main {
      display: flex;
      flex: 1;
      justify-content: center;
      align-items: flex-start;
      padding: 30px 20px;
      overflow-y: auto;
    }

    .panel {
      width: 100%;
      max-width: 500px;
      background: #141421;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      border: 1px solid #222;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .section {
      background: #1a1a2e;
      border-radius: 10px;
      padding: 18px;
    }

    .section h2 {
      font-size: 14px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .coord-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .coord-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .coord-group label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
    }

    .coord-row {
      display: flex;
      gap: 6px;
    }

    .coord-row input {
      width: 100%;
      padding: 8px;
      background: #0f0f1a;
      border: 1px solid #2a2a3e;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      text-align: center;
    }

    .coord-row input:focus {
      outline: none;
      border-color: #00d4aa;
    }

    .coord-row input[type="number"]::-webkit-outer-spin-button,
    .coord-row input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none; margin: 0;
    }
    .coord-row input[type="number"] { -moz-appearance: textfield; }

    .buttons { display: flex; gap: 8px; }

    button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }

    button:hover:not(:disabled) { opacity: 0.85; transform: translateY(-1px); }
    button:active:not(:disabled) { transform: translateY(1px); }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-start { background: #00d4aa; color: #000; }
    .btn-pause { background: #f5a623; color: #000; }
    .btn-resume { background: #4a9eff; color: #fff; }
    .btn-stop { background: #ff4a4a; color: #fff; }
    .btn-goto-base { background: #a78bfa; color: #fff; }
    .btn-sleep { background: #3b82f6; color: #fff; } /* Синий цвет для кнопки сна */

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat {
      background: #0f0f1a;
      padding: 16px 12px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 26px;
      font-weight: 700;
      color: #00d4aa;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-label { font-size: 12px; color: #666; margin-top: 6px; }

    .progress-bar {
      height: 8px;
      background: #0f0f1a;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d4aa, #4a9eff);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .bot-info {
      font-size: 14px;
      color: #888;
      line-height: 2;
      display: flex;
      justify-content: space-between;
    }

    .bot-info span {
      color: #e0e0e0;
      font-family: 'JetBrains Mono', monospace;
      background: #0f0f1a;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .error-msg {
      color: #ff4a4a;
      font-size: 13px;
      padding: 10px 12px;
      background: rgba(255, 74, 74, 0.1);
      border: 1px solid rgba(255, 74, 74, 0.2);
      border-radius: 6px;
      margin-top: 12px;
      display: none;
    }

    .hotbar {
      display: flex;
      gap: 6px;
      justify-content: center;
      padding: 12px;
      background: #0f0f1a;
      border-radius: 8px;
    }

    .hotbar-slot {
      flex: 1;
      aspect-ratio: 1;
      max-width: 45px;
      background: #1a1a2e;
      border: 2px solid #2a2a3e;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .hotbar-slot.active {
      border-color: #00d4aa;
      background: #233535;
      box-shadow: inset 0 0 8px rgba(0, 212, 170, 0.1);
    }

    .hotbar-slot-num {
      position: absolute;
      top: 2px;
      left: 4px;
      font-size: 9px;
      color: #555;
      font-weight: bold;
    }

    .hotbar-slot-name {
      color: #aaa;
      font-size: 8px;
      text-align: center;
      line-height: 1.1;
      word-break: break-all;
      padding: 0 2px;
    }

    .hotbar-slot-count {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
    }
  </style>
</head>
<body>
  <header>
    <h1>Lyaris Control Panel</h1>
    <div id="statusBadge" class="status-badge status-idle">idle</div>
  </header>

  <div class="main">
    <div class="panel">
      <div class="section">
        <h2>
          Mining Area 
          <span id="areaSize" style="color:#00d4aa;font-size:12px;font-weight:400;font-family:monospace;"></span>
        </h2>
        <div class="coord-grid">
          <div class="coord-group">
            <label>Corner 1</label>
            <div class="coord-row">
              <input type="number" id="x1" placeholder="X" oninput="schedulePreview()">
              <input type="number" id="y1" placeholder="Y" oninput="schedulePreview()">
              <input type="number" id="z1" placeholder="Z" oninput="schedulePreview()">
            </div>
          </div>
          <div class="coord-group">
            <label>Corner 2</label>
            <div class="coord-row">
              <input type="number" id="x2" placeholder="X" oninput="schedulePreview()">
              <input type="number" id="y2" placeholder="Y" oninput="schedulePreview()">
              <input type="number" id="z2" placeholder="Z" oninput="schedulePreview()">
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Controls</h2>
        <div class="buttons">
          <button class="btn-start" id="btnStart" onclick="startMining()">Start</button>
          <button class="btn-pause" id="btnPause" onclick="pauseMining()" disabled>Pause</button>
          <button class="btn-stop" id="btnStop" onclick="stopMining()" disabled>Stop</button>
        </div>
        <div id="resumeRow" style="margin-top:10px; display:none">
          <button class="btn-resume" onclick="resumeMining()" style="width:100%">Resume</button>
        </div>
      </div>

      <div class="section">
        <h2>Navigation</h2>
        <div class="buttons">
          <button class="btn-goto-base" id="btnGotoBase" onclick="gotoBase()">Go to Base</button>
          <button class="btn-sleep" id="btnSleep" onclick="goToBed()">Sleep</button>
        </div>
        <div class="buttons" style="margin-top: 10px;">
          <button class="btn-stop" id="btnStopTravel" onclick="stopMining()" disabled>Stop Travel</button>
        </div>
      </div>

      <div class="section">
        <h2>Progress</h2>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="minedCount">0</div>
            <div class="stat-label">Blocks Mined</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="totalCount">0</div>
            <div class="stat-label">Total Target</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="section">
        <h2>Bot Status</h2>
        <div class="bot-info">
          <div>Position: <span id="botPos">-</span></div>
          <div>Tool: <span id="currentTool">-</span></div>
        </div>
        <div class="error-msg" id="errorMsg"></div>
      </div>

      <div class="section">
        <h2>Inventory (Hotbar)</h2>
        <div class="hotbar" id="hotbar"></div>
      </div>
    </div>
  </div>

  <script>
    // Poll status
    setInterval(async () => {
      try {
        const res = await fetch('/api/status');
        const state = await res.json();
        updateUI(state);
      } catch {}
    }, 500);

    function updateUI(state) {
      // Status badge
      const badge = document.getElementById('statusBadge');
      badge.textContent = state.status;
      badge.className = `status-badge status-${state.status}`;

      // Stats
      document.getElementById('minedCount').textContent = state.minedBlocks;
      document.getElementById('totalCount').textContent = state.totalBlocks;

      const pct = state.totalBlocks > 0
        ? Math.round((state.minedBlocks / state.totalBlocks) * 100)
        : 0;
      document.getElementById('progressFill').style.width = pct + '%';

      // Bot info
      if (state.botPosition) {
        const p = state.botPosition;
        document.getElementById('botPos').textContent = `${p.x}, ${p.y}, ${p.z}`;
      }
      document.getElementById('currentTool').textContent = state.currentTool || 'Hand';

      // Buttons
      const isMining = state.status === 'mining';
      const isPaused = state.status === 'paused';
      const isTraveling = state.status === 'traveling';
      const isActive = isMining || isPaused || isTraveling;

      document.getElementById('btnStart').disabled = isActive;
      document.getElementById('btnPause').disabled = !isMining;
      document.getElementById('btnStop').disabled = !isActive;
      document.getElementById('resumeRow').style.display = isPaused ? 'block' : 'none';

      document.getElementById('btnGotoBase').disabled = isActive;
      document.getElementById('btnSleep').disabled = isActive;
      document.getElementById('btnStopTravel').disabled = !isTraveling;

      // Error
      const errorEl = document.getElementById('errorMsg');
      if (state.error) {
        errorEl.textContent = state.error;
        errorEl.style.display = 'block';
      } else {
        errorEl.style.display = 'none';
      }
    }

    async function startMining() {
      const body = {
        x1: Number(document.getElementById('x1').value),
        y1: Number(document.getElementById('y1').value),
        z1: Number(document.getElementById('z1').value),
        x2: Number(document.getElementById('x2').value),
        y2: Number(document.getElementById('y2').value),
        z2: Number(document.getElementById('z2').value),
      };

      if (Object.values(body).some(v => isNaN(v))) {
        alert('Enter all coordinates!');
        return;
      }

      await fetch('/api/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
    }

    async function pauseMining() { await fetch('/api/pause', { method: 'POST' }); }
    async function resumeMining() { await fetch('/api/resume', { method: 'POST' }); }
    async function stopMining() { await fetch('/api/stop', { method: 'POST' }); }
    async function gotoBase() { await fetch('/api/goto-base', { method: 'POST' }); }
    
    // Новая функция для сна
    async function goToBed() { await fetch('/api/sleep', { method: 'POST' }); }

    // --- Area preview ---
    let previewTimer = null;

    function getCoords() {
      const vals = ['x1','y1','z1','x2','y2','z2'].map(id => {
        const v = document.getElementById(id).value;
        return v === '' ? null : Number(v);
      });
      if (vals.some(v => v === null || isNaN(v))) return null;
      return vals;
    }

    function schedulePreview() {
      clearTimeout(previewTimer);
      previewTimer = setTimeout(sendPreview, 300);
    }

    async function sendPreview() {
      const c = getCoords();
      if (!c) {
        await fetch('/api/preview/clear', { method: 'POST' });
        document.getElementById('areaSize').textContent = '';
        return;
      }

      const [x1,y1,z1,x2,y2,z2] = c;
      const dx = Math.abs(x2-x1)+1, dy = Math.abs(y2-y1)+1, dz = Math.abs(z2-z1)+1;
      document.getElementById('areaSize').textContent = `${dx}×${dy}×${dz} = ${(dx*dy*dz).toLocaleString()} blocks`;

      await fetch('/api/preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ x1, y1, z1, x2, y2, z2 }),
      });
    }

    // --- Hotbar ---
    (function initHotbar() {
      const hotbar = document.getElementById('hotbar');
      for (let i = 0; i < 9; i++) {
        const slot = document.createElement('div');
        slot.className = 'hotbar-slot';
        slot.id = `hslot-${i}`;
        slot.innerHTML =
          `<span class="hotbar-slot-num">${i + 1}</span>` +
          `<span class="hotbar-slot-name"></span>` +
          `<span class="hotbar-slot-count"></span>`;
        hotbar.appendChild(slot);
      }
    })();

    function formatItemName(name) {
      const parts = name.split('_');
      if (parts.length === 1) {
        return name.charAt(0).toUpperCase() + name.slice(1, 6);
      }
      return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1, 4)).join('\n');
    }

    setInterval(async () => {
      try {
        const res = await fetch('/api/inventory');
        const { slots, activeSlot } = await res.json();
        for (let i = 0; i < 9; i++) {
          const slot = document.getElementById(`hslot-${i}`);
          const item = slots[i];
          slot.className = 'hotbar-slot' + (i === activeSlot ? ' active' : '');
          const nameEl = slot.querySelector('.hotbar-slot-name');
          const countEl = slot.querySelector('.hotbar-slot-count');
          if (item) {
            nameEl.textContent = formatItemName(item.name);
            countEl.textContent = item.count > 1 ? item.count : '';
          } else {
            nameEl.textContent = '';
            countEl.textContent = '';
          }
        }
      } catch {}
    }, 500);
  </script>
</body>
</html>